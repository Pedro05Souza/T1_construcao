# T1 Construção

## Build & Run Scripts (Makefile)

This project includes a comprehensive Makefile for easy development and CI/CD integration. To see all available commands:

```bash
make help
```

### Quick Start Commands

- **Complete setup and build:**
  ```bash
  make build
  ```

- **Fresh start (clean setup):**
  ```bash
  make fresh-start
  ```

- **Run the application:**
  ```bash
  make run
  ```

- **Development mode:**
  ```bash
  make run-dev
  ```

### Key Commands for CI/CD

- **CI build pipeline:**
  ```bash
  make ci-build
  ```

- **Run tests with coverage:**
  ```bash
  make test-coverage
  ```

- **Code quality checks:**
  ```bash
  make check
  ```

## Running the Project

### Using Make (Recommended)
```bash
make run
```

### Using Docker Compose directly
```bash
docker compose up
```

## Running Tests

To run tests:
```bash
poetry run pytest
```

## Development

To add new dependencies:
```bash
poetry add <package-name>
```

To add development dependencies:
```bash
poetry add --group dev <package-name>
```

To see installed packages:
```bash
poetry show
```

## CI/CD Integration

The project includes a GitHub Actions workflow (`.github/workflows/ci.yml`) that uses the Makefile commands:

- **Automated testing** on push/PR to main branch
- **Code quality checks** (linting, formatting, type checking)
- **Coverage reporting** with artifact uploads
- **Docker image building** for production

The CI pipeline uses these Makefile commands:
- `make ci-build` - Complete CI build pipeline
- `make ci-test` - Run tests with coverage and JUnit output
- `make docker-build` - Build Docker images

## Infrastructure with Terraform

This project uses **Terraform** to automatically create and manage AWS infrastructure (such as EC2 instances and security groups).

### Prerequisites

- [Terraform](https://developer.hashicorp.com/terraform/downloads)
- Configured AWS credentials (Access Key and Secret Key)
---

### AWS CLI Setup

Before using Terraform, export your AWS credentials or configure them using `aws configure`.
```bash
export AWS_ACCESS_KEY_ID="your_access_key"
export AWS_SECRET_ACCESS_KEY="your_secret_key"
export AWS_DEFAULT_REGION="us-east-1"
```
---

### Initializing Terraform

In the `infra/` directory, to download the required providers (such as AWS) and set up the environment, run:
```bash
terraform init
```

---

### Creating the Infrastructure

To apply the configuration and create the resources, run:
```bash
terraform apply
```
> Confirm by typing `yes` when prompted.

Terraform will create the EC2 instance and display its public IP address at the end of the process.

---

### Destroying the Infrastructure

When you want to **delete all created resources**, run:
```bash
terraform destroy
```
> Confirm with `yes` to remove the resources from AWS.

---

## Authentication and API Testing

To test the protected endpoints (any route under `/users`), you need a valid Access Token (JWT) generated by AWS Cognito. The infrastructure provisioned by Terraform (`infra/cognito.tf`) has already set up the User Pool, the `admin` and `user` groups, and the App Client.

### 1. Prerequisite: Create Test Users

Before generating a token, you must manually create the test users in the AWS console.

1.  Go to the [AWS Cognito Console](https://console.aws.amazon.com/cognito/home).
2.  Navigate to your User Pool: `t1-app-user-pool`.
3.  Go to **Users** and create two users:
    * One user `admin-user`.
    * One user `normal-user`.
    * (Check "Mark email as verified" and set a password).
4.  Go to **Groups**.
    * Add `admin-user` to the `admin` group.
    * Add `normal-user` to the `user` group.

---

### 2. Generate a Test Token (Quick Method)

We will use the "Implicit Grant" flow (which we manually enabled in the console) to get the token directly in the browser.

1.  **Access the Login (Hosted UI) URL:**
    Paste the complete link below into your browser. This link is already configured with your `client_id` and `response_type=token`.

    ```
    [https://t1-app-construcao-seu-nome-123.auth.us-east-1.amazoncognito.com/oauth2/authorize?client_id=1a352jaf2oivk10s9smivf537s&response_type=token&scope=openid+email+profile&redirect_uri=http://localhost:8000/token](https://t1-app-construcao-seu-nome-123.auth.us-east-1.amazoncognito.com/oauth2/authorize?client_id=1a352jaf2oivk10s9smivf537s&response_type=token&scope=openid+email+profile&redirect_uri=http://localhost:8000/token)
    ```

2.  **Log In:**
    * Log in with one of your test users (e.g., `admin-user`).

3.  **Copy the Access Token:**
    * You will be redirected to `http://localhost:8000/token...` and the page will show `{"detail":"Not Found"}`. **This is normal and expected.**
    * Look at the **browser's address bar**. It will contain the token:
    * `http://localhost:8000/token#access_token=`**`eyJraWQiOi...[GIANT_TOKEN_HERE]...&token_type=Bearer...`**
    * Copy *only* the `access_token` value (the huge string starting with `eyJ...` up to, but not including, the `&`).

---

### 3. Test the API (via Swagger)

1.  Run the API locally:

2.  Access Swagger at: `http://localhost:8000/docs`

3.  Click the **Authorize** button (top right).

4.  In the `bearerAuth` value box, paste the `access_token` you copied from the browser and click "Authorize".

5.  Close the popup. You are now authenticated.

#### Recommended Tests

* **Test (Admin):** Log in as `admin-user`, get the token, and try to execute `GET /users` or `DELETE /users/{id}`.
    * **Expected Result:** **Success (200 OK / 204 No Content)**.

* **Test (Normal User):** Log in as `normal-user`, get the token, and try to execute `GET /users`.
    * **Expected Result:** **Failure (403 Forbidden)** with the message `"detail": "Acesso restrito a administradores"`.

* **Test (Normal User - Self-Access):** While logged in as `normal-user`, get your own ID (the `sub` field from the token, which you can find on [JWT.io](https://jwt.io/)) and try `GET /users/{your-own-id}`.
    * **Expected Result:** **Success (200 OK)**.